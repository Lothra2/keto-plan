<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plan Keto 14 d√≠as</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #0f766e;
      --bg: #0f172a;
      --card: #0f172a;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,.6);
      --radius: 1.05rem;
    }
    [data-theme="light"] {
      --primary: #0f766e;
      --bg: #f1f5f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: rgba(15,23,42,.55);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(15,118,110,.25), var(--bg) 40%);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 70px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .9rem 1rem .5rem;
      gap: .8rem;
      background: rgba(15,23,42,.45);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 40;
    }
    [data-theme="light"] header {
      background: rgba(241,245,249,.7);
    }
    h1 { margin: 0; font-size: 1.1rem; }
    .sub { margin: .2rem 0 0; font-size: .7rem; opacity: .8; }
    .toggle {
      display: flex;
      align-items: center;
      gap: .3rem;
      font-size: .65rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .toggle input { display: none; }
    .ball {
      width: 40px;
      height: 20px;
      background: rgba(226,232,240,.25);
      border-radius: 999px;
      position: relative;
    }
    .ball::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left .28s;
    }
    input:checked + .ball {
      background: rgba(15,118,110,.85);
    }
    input:checked + .ball::after {
      left: 22px;
    }
    .hero {
      padding: .5rem 1rem .5rem;
    }
    .tip {
      background: linear-gradient(120deg, rgba(249,115,22,.15), rgba(15,118,110,.12));
      border: 1px solid rgba(15,118,110,.21);
      border-radius: .9rem;
      padding: .55rem .65rem .4rem;
      font-size: .7rem;
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .tabs {
      display: flex;
      gap: .4rem;
      padding: .4rem 1rem 0;
      overflow-x: auto;
    }
    .tab {
      border: none;
      background: transparent;
      padding: .4rem .75rem .45rem;
      border-radius: 999px;
      font-size: .7rem;
      color: var(--muted);
      flex-shrink: 0;
    }
    .tab.active {
      background: rgba(15,118,110,.15);
      color: var(--text);
    }
    .container {
      padding: .7rem 1rem 1.2rem;
    }
    .progress-summary {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: .5rem;
      font-size: .7rem;
    }
    .progress-line {
      height: 5px;
      background: rgba(148,163,184,.25);
      border-radius: 999px;
      flex: 1;
      overflow: hidden;
    }
    .progress-line span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, #0f766e, #f97316);
      width: 0%;
    }
    .week-switch {
      display: flex;
      gap: .5rem;
      margin-bottom: .6rem;
    }
    .week-btn {
      flex: 1;
      border: 1px solid rgba(148,163,184,.2);
      background: rgba(15,118,110,.03);
      border-radius: .8rem;
      padding: .4rem .3rem .45rem;
      font-size: .68rem;
      text-align: center;
      cursor: pointer;
    }
    .week-btn.active {
      background: rgba(15,118,110,.3);
      border-color: transparent;
      color: #fff;
    }
    .day-floating {
      display: flex;
      gap: .4rem;
      overflow-x: auto;
      margin-bottom: .65rem;
    }
    .day-pill {
      background: rgba(15,118,110,.03);
      border: 1px solid rgba(148,163,184,.1);
      border-radius: 999px;
      padding: .25rem .8rem;
      font-size: .65rem;
      white-space: nowrap;
      cursor: pointer;
    }
    .day-pill.active {
      background: var(--primary);
      color: #fff;
    }
    .day-card {
      background: radial-gradient(circle at top, rgba(15,118,110,.25), var(--card));
      border: 1px solid rgba(148,163,184,.08);
      border-radius: var(--radius);
      padding: .9rem .8rem .75rem;
      margin-bottom: .7rem;
      opacity: 0;
      transform: translateY(15px);
      transition: all .35s ease;
    }
    .day-card.show {
      opacity: 1;
      transform: translateY(0);
    }
    .day-title {
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      margin-bottom: .35rem;
    }
    .day-title h2 {
      font-size: .85rem;
      margin: 0;
    }
    .kcal {
      font-size: .62rem;
      opacity: .7;
    }
    .macros {
      display: flex;
      gap: .4rem;
      margin-bottom: .4rem;
    }
    .macro {
      background: rgba(15,118,110,.08);
      border-radius: .5rem;
      padding: .28rem .55rem;
      font-size: .6rem;
    }
    .food-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: .45rem;
    }
    .meal {
      background: rgba(15,23,42,.2);
      border: 1px solid rgba(15,118,110,.04);
      border-radius: .6rem;
      padding: .55rem .55rem .4rem;
      font-size: .68rem;
    }
    [data-theme="light"] .meal {
      background: rgba(255,255,255,.4);
    }
    .meal-title {
      display: flex;
      justify-content: space-between;
      gap: .4rem;
      margin-bottom: .15rem;
      font-weight: 600;
    }
    .meal-qty {
      font-size: .58rem;
      opacity: .6;
      text-align: right;
    }
    .day-actions {
      margin-top: .45rem;
      display: flex;
      gap: .4rem;
      flex-wrap: wrap;
    }
    .done-btn {
      border: none;
      background: rgba(34,197,94,.3);
      color: #ecfdf3;
      padding: .32rem .5rem .4rem;
      font-size: .6rem;
      border-radius: .5rem;
      cursor: pointer;
    }
    .done-btn.done {
      background: rgba(34,197,94,.5);
    }
    .swap-btn {
      border: none;
      background: rgba(15,118,110,.3);
      color: #fff;
      padding: .32rem .5rem .4rem;
      font-size: .6rem;
      border-radius: .5rem;
      cursor: pointer;
    }
    .list-row {
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(148,163,184,.08);
      border-radius: .7rem;
      padding: .55rem .6rem .35rem;
      font-size: .7rem;
      margin-bottom: .55rem;
    }
    .small { font-size: .62rem; opacity: .85; }
    input, textarea, select {
      width: 100%;
      background: rgba(15,23,42,.2);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: .5rem;
      padding: .5rem .45rem;
      color: inherit;
      font-size: .65rem;
      margin-bottom: .4rem;
    }
    button.save-btn {
      width: 100%;
      background: var(--primary);
      border: none;
      color: #fff;
      padding: .45rem .6rem .5rem;
      border-radius: .5rem;
      font-weight: 600;
      font-size: .65rem;
      cursor: pointer;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15,23,42,.9);
      display: flex;
      justify-content: space-around;
      gap: .5rem;
      padding: .25rem .5rem .3rem;
      z-index: 60;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .bottom-nav {
      background: rgba(241,245,249,.9);
    }
    .bottom-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: .6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .2rem;
      padding: .25rem .4rem;
      border-radius: .4rem;
    }
    .bottom-btn.active {
      color: var(--text);
      background: rgba(15,118,110,.15);
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 200;
    }
    .modal {
      background: var(--card);
      border-radius: .7rem;
      padding: .7rem .7rem .5rem;
      width: 100%;
      max-width: 360px;
    }
    .modal h2 {
      margin: 0 0 .35rem;
      font-size: .85rem;
    }
    .modal p {
      margin: 0 0 .45rem;
      font-size: .65rem;
      opacity: .75;
    }
    @media (min-width: 700px) {
      body { padding-bottom: 0; }
      .bottom-nav { display: none; }
      .container, header, .hero, .tabs { max-width: 760px; margin: 0 auto; }
      .food-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div>
      <h1 id="mainTitle">Plan Keto 14 d√≠as ü•ë</h1>
      <p class="sub" id="subTitle">Personalizado</p>
    </div>
    <label class="toggle">
      <input type="checkbox" id="themeToggle">
      <span class="ball"></span>
    </label>
  </header>

  <div class="hero">
    <div class="tip" id="tipBox">ü•§ Recuerda tomar agua con sal rosada en estos d√≠as.</div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="menu">Men√∫</button>
    <button class="tab" data-tab="compras">Compras</button>
    <button class="tab" data-tab="progreso">Progreso</button>
  </div>

  <!-- MEN√ö -->
  <div class="container" id="menu">
    <div class="progress-summary">
      <span id="progressText">0 de 14 d√≠as</span>
      <div class="progress-line"><span id="progressBar"></span></div>
    </div>
    <div class="week-switch">
      <div class="week-btn active" data-week="1">Semana 1 (1-7)</div>
      <div class="week-btn" data-week="2">Semana 2 (8-14)</div>
    </div>
    <div class="day-floating" id="dayFloating"></div>
    <div id="menuDays"></div>
  </div>

  <!-- COMPRAS -->
  <div class="container" id="compras" style="display:none"></div>

  <!-- PROGRESO -->
  <div class="container" id="progreso" style="display:none"></div>

  <div class="bottom-nav">
    <button class="bottom-btn active" data-tab="menu">üçΩ Men√∫</button>
    <button class="bottom-btn" data-tab="compras">üõí Compras</button>
    <button class="bottom-btn" data-tab="progreso">üìà Progreso</button>
  </div>

  <!-- modal nombres -->
  <div class="modal-backdrop" id="nameModal">
    <div class="modal">
      <h2>¬øQui√©n hace la dieta?</h2>
      <p>Pon uno o dos nombres para personalizar.</p>
      <input id="name1" placeholder="Nombre 1" />
      <input id="name2" placeholder="Nombre 2 (opcional)" />
      <button onclick="saveNames()">Guardar</button>
    </div>
  </div>

  <script>
    const LS_PREFIX = "keto14-rick-"
    const LS_NAMES = LS_PREFIX + "names"
    const LS_THEME = LS_PREFIX + "theme"
    const LS_START = LS_PREFIX + "start-date"
    const LS_ACTIVE_PERSON = LS_PREFIX + "active-person"
    let weightChart = null

    const plan = [
      {dia:"D√≠a 1",kcal:1650,macros:{carbs:"7%",prot:"25%",fat:"68%"},desayuno:{nombre:"Huevos con aguacate y feta",qty:"2 huevos, 1/2 aguacate, 30 g feta, 5 g mantequilla"},snackAM:{nombre:"Yogur griego con mara√±ones",qty:"120 g yogur, 20 g mara√±ones"},almuerzo:{nombre:"Salm√≥n con br√≥coli",qty:"150 g salm√≥n, 120 g br√≥coli, 10 g mantequilla"},snackPM:{nombre:"Feta con tomate cherry",qty:"30 g feta, 4 tomates"},cena:{nombre:"Bife de res con rocket y aguacate",qty:"160 g res, 40 g rocket, 1/2 aguacate"}},
      {dia:"D√≠a 2",kcal:1600,macros:{carbs:"8%",prot:"24%",fat:"68%"},desayuno:{nombre:"Omelette feta y tomate",qty:"2-3 huevos, 30 g feta, 40 g tomate"},snackAM:{nombre:"Mara√±ones y caf√©",qty:"20 g mara√±ones"},almuerzo:{nombre:"Pollo a la parrilla con rocket",qty:"150 g pollo, 50 g rocket, 1/2 aguacate"},snackPM:{nombre:"Yogur con coco",qty:"120 g yogur, 10 g coco"},cena:{nombre:"Camarones al ajillo con coliflor",qty:"140 g camar√≥n, 120 g coliflor"}},
      {dia:"D√≠a 3",kcal:1580,macros:{carbs:"6%",prot:"26%",fat:"68%"},desayuno:{nombre:"Yogur con nueces y ch√≠a",qty:"150 g yogur, 15 g nueces, 5 g ch√≠a"},snackAM:{nombre:"Feta y aguacate",qty:"25 g feta, 30 g aguacate"},almuerzo:{nombre:"Hamburguesa sin pan con rocket",qty:"150 g carne, 50 g rocket, 4 tomates"},snackPM:{nombre:"Mara√±ones",qty:"20 g"},cena:{nombre:"Salm√≥n con br√≥coli y mantequilla",qty:"150 g salm√≥n, 120 g br√≥coli, 5 g mantequilla"}},
      {dia:"D√≠a 4",kcal:1620,macros:{carbs:"7%",prot:"24%",fat:"69%"},desayuno:{nombre:"Huevos cocidos con aguacate",qty:"2 huevos, 1/2 aguacate"},snackAM:{nombre:"Yogur y mara√±ones",qty:"120 g yogur, 20 g mara√±ones"},almuerzo:{nombre:"Pollo en crema con champi√±√≥n y br√≥coli",qty:"150 g pollo, 60 g champi√±√≥n, 100 g br√≥coli, 20 ml crema"},snackPM:{nombre:"Feta con rocket",qty:"30 g feta, 20 g rocket"},cena:{nombre:"Carne roja con rocket y tomate seco",qty:"160 g carne, 40 g rocket, 15 g tomate seco"}},
      {dia:"D√≠a 5",kcal:1590,macros:{carbs:"8%",prot:"25%",fat:"67%"},desayuno:{nombre:"Omelette con feta y champi√±ones",qty:"2-3 huevos, 30 g feta, 50 g champi√±√≥n"},snackAM:{nombre:"Caf√© con crema + mara√±ones",qty:"caf√© + 10 ml crema + 15 g mara√±ones"},almuerzo:{nombre:"Ensalada keto de pollo",qty:"140 g pollo, 1/2 aguacate, 40 g tomate, 40 g rocket"},snackPM:{nombre:"Yogur con coco",qty:"120 g yogur, 10 g coco"},cena:{nombre:"Camarones con pur√© de coliflor",qty:"140 g camar√≥n, 120 g coliflor, 10 g mantequilla"}},
      {dia:"D√≠a 6",kcal:1600,macros:{carbs:"7%",prot:"25%",fat:"68%"},desayuno:{nombre:"Yogur con ch√≠a y nueces",qty:"150 g yogur, 5 g ch√≠a, 15 g nueces"},snackAM:{nombre:"Feta y aguacate",qty:"25 g feta, 30 g aguacate"},almuerzo:{nombre:"Bife con ensalada y feta",qty:"160 g res, 40 g hojas verdes, 20 g feta"},snackPM:{nombre:"Mara√±ones",qty:"20 g"},cena:{nombre:"Pollo al horno con br√≥coli gratinado",qty:"150 g pollo, 100 g br√≥coli, 20 g queso"}},
      {dia:"D√≠a 7",kcal:1580,macros:{carbs:"7%",prot:"24%",fat:"69%"},desayuno:{nombre:"Huevos revueltos con mantequilla y aguacate",qty:"2 huevos, 1/2 aguacate, 5 g mantequilla"},snackAM:{nombre:"Yogur + ch√≠a",qty:"120 g yogur, 5 g ch√≠a"},almuerzo:{nombre:"Ensalada de salm√≥n con rocket y feta",qty:"140 g salm√≥n, 40 g rocket, 20 g feta"},snackPM:{nombre:"Feta con tomate",qty:"30 g feta, 4 tomates"},cena:{nombre:"Filete de res con br√≥coli",qty:"160 g res, 100 g br√≥coli, 5 g mantequilla"}},
      {dia:"D√≠a 8",kcal:1600,macros:{carbs:"7%",prot:"25%",fat:"68%"},desayuno:{nombre:"Omelette 3 huevos con feta y rocket",qty:"3 huevos, 30 g feta, 30 g rocket"},snackAM:{nombre:"Yogur con mara√±ones",qty:"120 g yogur, 20 g mara√±ones"},almuerzo:{nombre:"Pollo salteado con br√≥coli",qty:"150 g pollo, 100 g br√≥coli, 5 ml aceite"},snackPM:{nombre:"Feta y aguacate",qty:"25 g feta, 30 g aguacate"},cena:{nombre:"Salm√≥n con mantequilla de ajo",qty:"150 g salm√≥n, 5 g mantequilla"}},
      {dia:"D√≠a 9",kcal:1590,macros:{carbs:"7%",prot:"25%",fat:"68%"},desayuno:{nombre:"Yogur con nueces y coco",qty:"150 g yogur, 10 g coco, 15 g nueces"},snackAM:{nombre:"Feta y tomate",qty:"25 g feta, 4 tomates"},almuerzo:{nombre:"Bife con rocket y aguacate",qty:"160 g res, 40 g rocket, 1/2 aguacate"},snackPM:{nombre:"Mara√±ones o almendras",qty:"20 g"},cena:{nombre:"Camarones con crema y br√≥coli",qty:"140 g camar√≥n, 100 g br√≥coli, 20 ml crema"}},
      {dia:"D√≠a 10",kcal:1600,macros:{carbs:"8%",prot:"24%",fat:"68%"},desayuno:{nombre:"Huevos fritos con aguacate",qty:"2 huevos, 1/2 aguacate"},snackAM:{nombre:"Yogur con ch√≠a",qty:"120 g yogur, 5 g ch√≠a"},almuerzo:{nombre:"Pollo al curry sin arroz con coliflor",qty:"150 g pollo, 100 g coliflor"},snackPM:{nombre:"Feta con rocket",qty:"25 g feta, 20 g rocket"},cena:{nombre:"Salm√≥n con tomate y feta",qty:"150 g salm√≥n, 40 g tomate, 20 g feta"}},
      {dia:"D√≠a 11",kcal:1590,macros:{carbs:"7%",prot:"25%",fat:"68%"},desayuno:{nombre:"Omelette con champi√±ones y feta",qty:"2-3 huevos, 50 g champi√±√≥n, 20 g feta"},snackAM:{nombre:"Mara√±ones",qty:"20 g"},almuerzo:{nombre:"Ensalada de pollo y aguacate",qty:"140 g pollo, 1/2 aguacate, 40 g rocket"},snackPM:{nombre:"Yogur con coco",qty:"120 g yogur, 10 g coco"},cena:{nombre:"Carne roja con pur√© de coliflor",qty:"160 g carne, 120 g coliflor"}},
      {dia:"D√≠a 12",kcal:1580,macros:{carbs:"7%",prot:"24%",fat:"69%"},desayuno:{nombre:"Yogur con nueces",qty:"150 g yogur, 15 g nueces"},snackAM:{nombre:"Feta y aguacate",qty:"25 g feta, 30 g aguacate"},almuerzo:{nombre:"Camarones al ajillo con ensalada",qty:"140 g camar√≥n, 50 g hojas verdes, 5 ml aceite"},snackPM:{nombre:"Caf√© con crema + mara√±ones",qty:"10 ml crema, 15 g mara√±ones"},cena:{nombre:"Pollo al horno con br√≥coli y feta",qty:"150 g pollo, 100 g br√≥coli, 20 g feta"}},
      {dia:"D√≠a 13",kcal:1600,macros:{carbs:"7%",prot:"24%",fat:"69%"},desayuno:{nombre:"Huevos cocidos con aguacate",qty:"2 huevos, 1/2 aguacate"},snackAM:{nombre:"Yogur con coco",qty:"120 g yogur, 10 g coco"},almuerzo:{nombre:"Bife con tomate y rocket",qty:"160 g res, 40 g rocket, 40 g tomate"},snackPM:{nombre:"Feta con nueces",qty:"25 g feta, 10 g nueces"},cena:{nombre:"Salm√≥n con mantequilla y br√≥coli",qty:"150 g salm√≥n, 100 g br√≥coli, 5 g mantequilla"}},
      {dia:"D√≠a 14",kcal:1600,macros:{carbs:"7%",prot:"24%",fat:"69%"},desayuno:{nombre:"Omelette feta y rocket",qty:"2-3 huevos, 30 g feta, 30 g rocket"},snackAM:{nombre:"Yogur con ch√≠a",qty:"120 g yogur, 5 g ch√≠a"},almuerzo:{nombre:"Pollo con aguacate y tomate",qty:"140 g pollo, 1/2 aguacate, 40 g tomate"},snackPM:{nombre:"Mara√±ones o feta",qty:"20 g mara√±ones o 25 g feta"},cena:{nombre:"Filete de res con br√≥coli y mantequilla",qty:"160 g res, 100 g br√≥coli, 5 g mantequilla"}}
    ]

    // cenas alternativas
    const cenaSwaps = [
      {nombre:"Pollo 150 g con br√≥coli 120 g y mantequilla 5 g",qty:"150 g pollo, 120 g br√≥coli, 5 g mantequilla"},
      {nombre:"Hamburguesa sin pan con queso y ensalada",qty:"150 g carne, 20 g queso, ensalada verde"},
      {nombre:"Salm√≥n 140 g con ensalada verde",qty:"140 g salm√≥n, 50 g hojas verdes"}
    ]

    const tips = [
      "ü•§ Tomen agua con un poco de sal.",
      "ü•ë Si hay hambre suban grasa.",
      "üç≥ Dos huevos extra est√°n bien.",
      "üì∏ Foto d√≠a 1 y d√≠a 14.",
      "üß¥ Pueden cambiar mantequilla por aceite."
    ]

    function setRandomTip(names) {
      const tipBox = document.getElementById("tipBox")
      const base = tips[Math.floor(Math.random() * tips.length)]
      if (names && names.length) {
        tipBox.textContent = base + " " + names.join(" y ") + "."
      } else {
        tipBox.textContent = base
      }
    }

    function saveNames() {
      const n1 = document.getElementById("name1").value.trim()
      const n2 = document.getElementById("name2").value.trim()
      const names = []
      if (n1) names.push(n1)
      if (n2) names.push(n2)
      localStorage.setItem(LS_NAMES, JSON.stringify(names))
      // guardar el primero como activo
      if (names.length) {
        localStorage.setItem(LS_ACTIVE_PERSON, names[0])
      }
      document.getElementById("nameModal").style.display = "none"
      setHeaderNames(names)
      setRandomTip(names)
    }

    function setHeaderNames(names) {
      const sub = document.getElementById("subTitle")
      if (names && names.length) {
        sub.textContent = "Para " + names.join(" y ")
      } else {
        sub.textContent = "Personalizado"
      }
    }

    function askStartDateIfNeeded() {
      const saved = localStorage.getItem(LS_START)
      if (!saved) {
        const today = new Date().toISOString().slice(0,10)
        localStorage.setItem(LS_START, today)
      }
    }

    function getCurrentDayIndex() {
      const saved = localStorage.getItem(LS_START)
      if (!saved) return 0
      const start = new Date(saved)
      const today = new Date()
      const diffMs = today - start
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))
      if (diffDays < 0) return 0
      if (diffDays > 13) return 13
      return diffDays
    }

    function renderDayPills(week) {
      const wrap = document.getElementById("dayFloating")
      wrap.innerHTML = ""
      const start = week === 1 ? 0 : 7
      const end = week === 1 ? 7 : 14
      for (let i = start; i < end; i++) {
        const pill = document.createElement("div")
        pill.className = "day-pill"
        pill.textContent = plan[i].dia
        pill.onclick = () => renderMenuDay(i, week)
        wrap.appendChild(pill)
      }
    }

    function getCompletedCount() {
      let count = 0
      for (let i = 0; i < plan.length; i++) {
        if (localStorage.getItem(LS_PREFIX + "done-" + i) === "1") count++
      }
      return count
    }

    function updateProgressBar() {
      const count = getCompletedCount()
      document.getElementById("progressText").textContent = count + " de 14 d√≠as"
      document.getElementById("progressBar").style.width = (count / 14 * 100) + "%"
    }

    function renderMenuDay(idx, week) {
      const menuDays = document.getElementById("menuDays")
      menuDays.innerHTML = ""
      const day = plan[idx]
      const done = localStorage.getItem(LS_PREFIX + "done-" + idx) === "1"
      const card = document.createElement("div")
      card.className = "day-card"
      card.innerHTML = `
        <div class="day-title">
          <h2>${day.dia}</h2>
          <div class="kcal">${day.kcal} kcal</div>
        </div>
        <div class="macros">
          <div class="macro">Carbs ${day.macros.carbs}</div>
          <div class="macro">Prote ${day.macros.prot}</div>
          <div class="macro">Grasa ${day.macros.fat}</div>
        </div>
        <div class="food-grid">
          <div class="meal">
            <div class="meal-title"><span>üç≥ Desayuno</span><span class="meal-qty">${day.desayuno.qty}</span></div>
            <div>${day.desayuno.nombre}</div>
          </div>
          <div class="meal">
            <div class="meal-title"><span>‚è∞ Snack AM</span><span class="meal-qty">${day.snackAM.qty}</span></div>
            <div>${day.snackAM.nombre}</div>
          </div>
          <div class="meal">
            <div class="meal-title"><span>ü•ó Almuerzo</span><span class="meal-qty">${day.almuerzo.qty}</span></div>
            <div>${day.almuerzo.nombre}</div>
          </div>
          <div class="meal">
            <div class="meal-title"><span>ü•ú Snack PM</span><span class="meal-qty">${day.snackPM.qty}</span></div>
            <div>${day.snackPM.nombre}</div>
          </div>
          <div class="meal" id="cena-block">
            <div class="meal-title"><span>üçñ Cena</span><span class="meal-qty">${day.cena.qty}</span></div>
            <div id="cena-text">${day.cena.nombre}</div>
          </div>
        </div>
        <div class="day-actions">
          <button class="done-btn ${done ? "done" : ""}" onclick="toggleDone(${idx}, ${week})">${done ? "‚úî D√≠a completado" : "Marcar d√≠a ‚úî"}</button>
          <button class="swap-btn" onclick="swapCena(${idx}, ${week})">Cambiar cena üîÅ</button>
        </div>
      `
      menuDays.appendChild(card)
      animateCards()

      document.querySelectorAll(".day-pill").forEach((p, i) => {
        const base = week === 1 ? 0 : 7
        p.classList.toggle("active", (i + base) === idx)
      })
    }

    function toggleDone(idx, week) {
      const key = LS_PREFIX + "done-" + idx
      const cur = localStorage.getItem(key) === "1"
      localStorage.setItem(key, cur ? "0" : "1")
      renderMenuDay(idx, week)
      updateProgressBar()
    }
    window.toggleDone = toggleDone

    function swapCena(idx, week) {
      const option = cenaSwaps[Math.floor(Math.random() * cenaSwaps.length)]
      // no tocamos el plan original, solo pintamos de nuevo
      const menuDays = document.getElementById("menuDays")
      renderMenuDay(idx, week)
      const cenaText = document.querySelector("#menuDays #cena-text")
      const cenaBlock = document.querySelector("#menuDays #cena-block .meal-qty")
      if (cenaText && cenaBlock) {
        cenaText.textContent = option.nombre
        cenaBlock.textContent = option.qty
      }
    }
    window.swapCena = swapCena

    function renderCompras() {
      const container = document.getElementById("compras")
      container.innerHTML = ""

      // dashboard semanal
      const done = getCompletedCount()
      const doneWeek1 = Array.from({length:7}).filter((_,i)=>localStorage.getItem(LS_PREFIX+"done-"+i)==="1").length
      const doneWeek2 = Array.from({length:7}).filter((_,i)=>localStorage.getItem(LS_PREFIX+"done-"+(i+7))==="1").length
      const dash = document.createElement("div")
      dash.className = "list-row"
      dash.innerHTML = `
        <strong>Resumen r√°pido</strong>
        <div class="small">Total completado: ${done} de 14</div>
        <div class="small">Semana 1: ${doneWeek1} de 7</div>
        <div class="small">Semana 2: ${doneWeek2} de 7</div>
      `
      container.appendChild(dash)

      const list = [
        {cat:"Prote√≠nas",items:"Huevos, pollo, salm√≥n, camarones, carne de res, yogur griego"},
        {cat:"Verduras",items:"Br√≥coli, coliflor, tomate cherry, rocket/r√∫cula, aguacate, champi√±√≥n"},
        {cat:"Grasas buenas",items:"Mantequilla, aceite de oliva, crema de leche, queso feta"},
        {cat:"Snacks",items:"Mara√±ones, nueces, ch√≠a, coco rallado"},
        {cat:"Otros",items:"Caf√© sin az√∫car, sal rosada, lim√≥n"}
      ]
      list.forEach(it => {
        const row = document.createElement("div")
        row.className = "list-row"
        row.innerHTML = `<strong>${it.cat}</strong><div class="small">${it.items}</div>`
        container.appendChild(row)
      })
      animateCards()
    }

    function renderProgreso() {
      const container = document.getElementById("progreso")
      container.innerHTML = ""

      // selector de persona
      const names = JSON.parse(localStorage.getItem(LS_NAMES) || "[]")
      const activePerson = localStorage.getItem(LS_ACTIVE_PERSON) || (names[0] || "default")
      if (names.length) {
        const sel = document.createElement("select")
        sel.id = "personSelect"
        names.forEach(n => {
          const opt = document.createElement("option")
          opt.value = n
          opt.textContent = n
          if (n === activePerson) opt.selected = true
          sel.appendChild(opt)
        })
        sel.addEventListener("change", e => {
          localStorage.setItem(LS_ACTIVE_PERSON, e.target.value)
          renderProgreso()
        })
        const rowSel = document.createElement("div")
        rowSel.className = "list-row"
        rowSel.innerHTML = "<strong>Progreso por persona</strong>"
        rowSel.appendChild(sel)
        container.appendChild(rowSel)
      }

      const canvas = document.createElement("canvas")
      canvas.id = "weightChart"
      canvas.style.maxWidth = "100%"
      container.appendChild(canvas)

      const note = document.createElement("div")
      note.className = "list-row"
      note.textContent = "Se guarda en este navegador. Cada nombre tiene su propio registro."
      container.appendChild(note)

      plan.forEach((d, idx) => {
        const key = LS_PREFIX + "prog-" + activePerson + "-" + idx
        const saved = JSON.parse(localStorage.getItem(key) || "{}")
        const card = document.createElement("div")
        card.className = "day-card"
        card.innerHTML = `
          <div class="day-title"><h2>${d.dia}</h2><span class="kcal">${d.kcal} kcal</span></div>
          <input type="number" placeholder="Peso (kg)" id="peso-${idx}" value="${saved.peso || ""}">
          <input type="number" placeholder="Cintura (cm)" id="cintura-${idx}" value="${saved.cintura || ""}">
          <input type="number" placeholder="Energ√≠a (1-10)" id="energia-${idx}" value="${saved.energia || ""}">
          <textarea placeholder="Notas" id="nota-${idx}">${saved.notas || ""}</textarea>
          <button class="save-btn" onclick="saveProgreso(${idx})">Guardar</button>
        `
        container.appendChild(card)
      })
      animateCards()
      drawChart()
    }

    function saveProgreso(idx) {
      const names = JSON.parse(localStorage.getItem(LS_NAMES) || "[]")
      const activePerson = localStorage.getItem(LS_ACTIVE_PERSON) || (names[0] || "default")
      const data = {
        peso: document.getElementById("peso-" + idx).value,
        cintura: document.getElementById("cintura-" + idx).value,
        energia: document.getElementById("energia-" + idx).value,
        notas: document.getElementById("nota-" + idx).value
      }
      const key = LS_PREFIX + "prog-" + activePerson + "-" + idx
      localStorage.setItem(key, JSON.stringify(data))
      alert("‚úÖ Guardado para " + activePerson)
      drawChart()
    }
    window.saveProgreso = saveProgreso

    function switchTab(target) {
      const sections = ["menu","compras","progreso"]
      sections.forEach(id => {
        const el = document.getElementById(id)
        el.style.display = id === target ? "block" : "none"
        if (id === "progreso" && target !== "progreso") {
          if (weightChart) {
            weightChart.destroy()
            weightChart = null
          }
          el.innerHTML = ""
        }
      })
      document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === target))
      document.querySelectorAll(".bottom-btn").forEach(t => t.classList.toggle("active", t.dataset.tab === target))

      if (target === "menu") {
        // mostrar d√≠a actual seg√∫n fecha
        const idx = getCurrentDayIndex()
        const week = idx < 7 ? 1 : 2
        renderDayPills(week)
        renderMenuDay(idx, week)
        updateProgressBar()
      }
      if (target === "compras") renderCompras()
      if (target === "progreso") renderProgreso()
    }

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => switchTab(tab.dataset.tab))
    })
    document.querySelectorAll(".bottom-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab))
    })

    document.addEventListener("click", e => {
      if (e.target.classList.contains("week-btn")) {
        document.querySelectorAll(".week-btn").forEach(b => b.classList.remove("active"))
        e.target.classList.add("active")
        const week = Number(e.target.dataset.week)
        renderDayPills(week)
        const idx = week === 1 ? 0 : 7
        renderMenuDay(idx, week)
      }
    })

    const themeToggle = document.getElementById("themeToggle")
    const savedTheme = localStorage.getItem(LS_THEME) || "dark"
    document.body.setAttribute("data-theme", savedTheme)
    themeToggle.checked = savedTheme === "dark"
    themeToggle.addEventListener("change", () => {
      const mode = themeToggle.checked ? "dark" : "light"
      document.body.setAttribute("data-theme", mode)
      localStorage.setItem(LS_THEME, mode)
    })

    function animateCards() {
      const items = document.querySelectorAll(".day-card, .list-row")
      if ("IntersectionObserver" in window) {
        const observer = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) e.target.classList.add("show")
          })
        }, {threshold: .15})
        items.forEach(i => observer.observe(i))
      } else {
        items.forEach(i => i.classList.add("show"))
      }
    }

    function drawChart() {
      const ctx = document.getElementById("weightChart")
      if (!ctx || typeof Chart === "undefined") return
      const names = JSON.parse(localStorage.getItem(LS_NAMES) || "[]")
      const activePerson = localStorage.getItem(LS_ACTIVE_PERSON) || (names[0] || "default")
      const weights = plan.map((_, idx) => {
        const saved = JSON.parse(localStorage.getItem(LS_PREFIX + "prog-" + activePerson + "-" + idx) || "{}")
        return saved.peso ? parseFloat(saved.peso) : null
      })
      if (weightChart) weightChart.destroy()
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: plan.map(p => p.dia),
          datasets: [{
            label: 'Peso (kg)',
            data: weights,
            borderWidth: 2,
            tension: .35
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: false } }
        }
      })
      ctx.parentElement.style.height = "180px"
    }

    ;(function init() {
      // nombres
      const names = JSON.parse(localStorage.getItem(LS_NAMES) || "[]")
      if (!names.length) {
        document.getElementById("nameModal").style.display = "flex"
      } else {
        setHeaderNames(names)
        setRandomTip(names)
      }
      // fecha de inicio
      askStartDateIfNeeded()
      const idx = getCurrentDayIndex()
      const week = idx < 7 ? 1 : 2
      renderDayPills(week)
      renderMenuDay(idx, week)
      updateProgressBar()
    })()
  </script>
</body>
</html>
